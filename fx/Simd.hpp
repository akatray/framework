// ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// Pragma.
// ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#pragma once

// ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// Imports.
// ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#include <fx/Types.hpp>
#include <fx/Allocator.hpp>
#include <immintrin.h>

// ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// Framework - Gotta go fast.
// ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
namespace fx::simd
{
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// That rare case.
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	class AllocatorAligned : public Allocator
	{
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// Data.
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		u64 Aligment;
		public:
		
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// Default constructor. AVX 256-bit.
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		AllocatorAligned ( void ) : Aligment(32) {}

		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// Explicit constructor: For even more rare case.
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		AllocatorAligned ( const u64 _Aligment ) : Aligment(_Aligment) {}

		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// Destructor.
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		~AllocatorAligned ( void ) override {}

		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// Allocate memory. Size in bytes.
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		auto alloc ( const u64 _Size ) -> ptr override
		{
			return _mm_malloc(_Size, this->Aligment);
		}

		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// Free memory.
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		auto free ( void* _Pointer ) -> void override
		{
			_mm_free(_Pointer);
		}
	};

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Default aligned memory providers.
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	auto AllocSimd16 = AllocatorAligned(16);
	auto AllocSimd32 = AllocatorAligned(32);
	auto AllocSimd64 = AllocatorAligned(64);

}